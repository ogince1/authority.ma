import { createClient } from '@supabase/supabase-js';

// Configuration Supabase avec cl√© anonyme
const supabaseUrl = 'https://lqldqgbpaxqaazfjzlsz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxbGRxZ2JwYXhxYWF6Zmp6bHN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NjQxOTEsImV4cCI6MjA2OTE0MDE5MX0.b3c4OMwKQwNgFBQSS-oGXsWzsdXY1NPnEcxXQUz7HLI';

const supabase = createClient(supabaseUrl, supabaseKey);

async function testSpecificUsers() {
  console.log('üß™ Test sp√©cifique entre abderrahimmloatefpro@gmail.com (annonceur) & ogincema@gmail.com (√©diteur)\n');

  try {
    // 1. Rechercher les utilisateurs
    console.log('1Ô∏è‚É£ Recherche des utilisateurs...');
    
    const { data: advertiser, error: advertiserError } = await supabase
      .from('users')
      .select('*')
      .eq('email', 'abderrahimmolatefpro@gmail.com')
      .single();
    
    if (advertiserError) {
      console.log(`‚ùå Erreur recherche annonceur: ${advertiserError.message}`);
      return;
    }
    
    const { data: publisher, error: publisherError } = await supabase
      .from('users')
      .select('*')
      .eq('email', 'ogincema@gmail.com')
      .single();
    
    if (publisherError) {
      console.log(`‚ùå Erreur recherche √©diteur: ${publisherError.message}`);
      return;
    }
    
    console.log('‚úÖ Annonceur trouv√©:', {
      id: advertiser.id,
      email: advertiser.email,
      name: advertiser.name || 'N/A'
    });
    console.log('‚úÖ √âditeur trouv√©:', {
      id: publisher.id,
      email: publisher.email,
      name: publisher.name || 'N/A'
    });
    console.log('');

    // 2. Rechercher un website de l'√©diteur
    console.log('2Ô∏è‚É£ Recherche d\'un website de l\'√©diteur...');
    
    const { data: website, error: websiteError } = await supabase
      .from('websites')
      .select('*')
      .eq('user_id', publisher.id)
      .limit(1)
      .single();
    
    if (websiteError) {
      console.log(`‚ùå Erreur recherche website: ${websiteError.message}`);
      return;
    }
    
    console.log('‚úÖ Website trouv√©:', {
      id: website.id,
      domain: website.domain,
      title: website.title || 'N/A'
    });
    console.log('');

    // 3. Cr√©er un link_listing virtuel pour le nouveau article
    console.log('3Ô∏è‚É£ Cr√©ation d\'un link_listing virtuel...');
    
    const { data: virtualListing, error: listingError } = await supabase
      .from('link_listings')
      .insert({
        website_id: website.id,
        user_id: publisher.id,
        title: 'Nouvel article - Leplombier',
        description: 'Article qui sera r√©dig√© par la plateforme',
        target_url: 'https://example.com/virtual-article',
        anchor_text: 'Article R√©daction Plateforme',
        link_type: 'dofollow',
        position: 'content',
        price: 90, // Prix de la r√©daction
        currency: 'MAD',
        minimum_contract_duration: 1,
        max_links_per_page: 1,
        status: 'active',
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (listingError) {
      console.log(`‚ùå Erreur cr√©ation link_listing: ${listingError.message}`);
      return;
    }
    
    console.log('‚úÖ Link_listing virtuel cr√©√©:', {
      id: virtualListing.id,
      type: virtualListing.type,
      title: virtualListing.title
    });
    console.log('');

    // 4. Cr√©er une demande d'achat avec r√©daction par la plateforme
    console.log('4Ô∏è‚É£ Cr√©ation d\'une demande d\'achat avec r√©daction par la plateforme...');
    
    const newRequest = {
      user_id: advertiser.id, // Annonceur
      publisher_id: publisher.id, // √âditeur
      link_listing_id: virtualListing.id, // Lien vers le listing virtuel
      anchor_text: 'Test Article R√©daction Plateforme',
      target_url: 'https://example.com/test-article',
      content_option: 'platform', // R√©daction par la plateforme
      proposed_price: 90, // Prix propos√©
      status: 'pending',
      extended_status: 'pending',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    const { data: createdRequest, error: createError } = await supabase
      .from('link_purchase_requests')
      .insert(newRequest)
      .select()
      .single();
    
    if (createError) {
      console.log(`‚ùå Erreur cr√©ation demande: ${createError.message}`);
      return;
    }
    
    console.log('‚úÖ Demande cr√©√©e:', {
      id: createdRequest.id,
      anchor_text: createdRequest.anchor_text,
      content_option: createdRequest.content_option,
      status: createdRequest.status,
      extended_status: createdRequest.extended_status
    });
    console.log('');

    // 5. Simuler l'acceptation de la demande par l'√©diteur
    console.log('5Ô∏è‚É£ Simulation de l\'acceptation par l\'√©diteur...');
    
    const { error: acceptError } = await supabase
      .from('link_purchase_requests')
      .update({
        extended_status: 'accepted_waiting_article',
        status: 'accepted',
        updated_at: new Date().toISOString()
      })
      .eq('id', createdRequest.id);
    
    if (acceptError) {
      console.log(`‚ùå Erreur acceptation: ${acceptError.message}`);
      return;
    }
    
    console.log('‚úÖ Demande accept√©e par l\'√©diteur');
    console.log('');

    // 6. Cr√©er une conversation (comme dans le code frontend)
    console.log('6Ô∏è‚É£ Cr√©ation d\'une conversation...');
    
    const { data: conversation, error: conversationError } = await supabase
      .from('conversations')
      .insert({
        purchase_request_id: createdRequest.id,
        advertiser_id: advertiser.id,
        publisher_id: publisher.id,
        subject: `Demande accept√©e - ${createdRequest.anchor_text}`,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (conversationError) {
      console.log(`‚ùå Erreur cr√©ation conversation: ${conversationError.message}`);
      return;
    }
    
    console.log('‚úÖ Conversation cr√©√©e:', {
      id: conversation.id,
      subject: conversation.subject,
      advertiser_id: conversation.advertiser_id,
      publisher_id: conversation.publisher_id
    });
    console.log('');

    // 7. Ajouter le message initial de l'√©diteur
    console.log('7Ô∏è‚É£ Ajout du message initial de l\'√©diteur...');
    
    const { data: initialMessage, error: initialMessageError } = await supabase
      .from('conversation_messages')
      .insert({
        conversation_id: conversation.id,
        sender_id: publisher.id, // √âditeur
        receiver_id: advertiser.id, // Annonceur
        content: `Bonjour ! J'ai accept√© votre demande pour le lien "${createdRequest.anchor_text}". L'√©quipe va maintenant r√©diger l'article pour vous.`,
        message_type: 'text',
        related_purchase_request_id: createdRequest.id
      })
      .select()
      .single();
    
    if (initialMessageError) {
      console.log(`‚ùå Erreur message initial: ${initialMessageError.message}`);
      return;
    }
    
    console.log('‚úÖ Message initial envoy√©:', {
      id: initialMessage.id,
      content: initialMessage.content.substring(0, 50) + '...',
      sender_id: initialMessage.sender_id,
      receiver_id: initialMessage.receiver_id
    });
    console.log('');

    // 8. Simuler une r√©ponse de l'annonceur
    console.log('8Ô∏è‚É£ Simulation d\'une r√©ponse de l\'annonceur...');
    
    const { data: replyMessage, error: replyError } = await supabase
      .from('conversation_messages')
      .insert({
        conversation_id: conversation.id,
        sender_id: advertiser.id, // Annonceur
        receiver_id: publisher.id, // √âditeur
        content: 'Merci pour l\'acceptation ! J\'attends l\'article avec impatience. Pouvez-vous me donner une estimation du d√©lai ?',
        message_type: 'text',
        related_purchase_request_id: createdRequest.id
      })
      .select()
      .single();
    
    if (replyError) {
      console.log(`‚ùå Erreur message de r√©ponse: ${replyError.message}`);
      return;
    }
    
    console.log('‚úÖ Message de r√©ponse envoy√©:', {
      id: replyMessage.id,
      content: replyMessage.content.substring(0, 50) + '...',
      sender_id: replyMessage.sender_id,
      receiver_id: replyMessage.receiver_id
    });
    console.log('');

    // 9. Simuler une r√©ponse de l'√©diteur
    console.log('9Ô∏è‚É£ Simulation d\'une r√©ponse de l\'√©diteur...');
    
    const { data: publisherReply, error: publisherReplyError } = await supabase
      .from('conversation_messages')
      .insert({
        conversation_id: conversation.id,
        sender_id: publisher.id, // √âditeur
        receiver_id: advertiser.id, // Annonceur
        content: 'Parfait ! L\'article sera r√©dig√© dans les 2-3 prochains jours ouvrables. Je vous tiendrai inform√© de l\'avancement.',
        message_type: 'text',
        related_purchase_request_id: createdRequest.id
      })
      .select()
      .single();
    
    if (publisherReplyError) {
      console.log(`‚ùå Erreur r√©ponse √©diteur: ${publisherReplyError.message}`);
      return;
    }
    
    console.log('‚úÖ R√©ponse de l\'√©diteur envoy√©e:', {
      id: publisherReply.id,
      content: publisherReply.content.substring(0, 50) + '...',
      sender_id: publisherReply.sender_id,
      receiver_id: publisherReply.receiver_id
    });
    console.log('');

    // 10. V√©rification finale de la conversation
    console.log('üîü V√©rification finale de la conversation...');
    
    const { data: finalConversation, error: finalConvError } = await supabase
      .from('conversations')
      .select(`
        *,
        messages:conversation_messages(*)
      `)
      .eq('id', conversation.id)
      .single();
    
    if (finalConvError) {
      console.log(`‚ùå Erreur v√©rification finale: ${finalConvError.message}`);
      return;
    }
    
    console.log('‚úÖ V√©rification r√©ussie !');
    console.log('üìä R√©sum√© de la conversation:');
    console.log(`   - Conversation ID: ${finalConversation.id}`);
    console.log(`   - Sujet: ${finalConversation.subject}`);
    console.log(`   - Nombre de messages: ${finalConversation.messages.length}`);
    console.log(`   - Annonceur: ${advertiser.email}`);
    console.log(`   - √âditeur: ${publisher.email}`);
    console.log('');

    // 11. Afficher tous les messages de la conversation
    console.log('üì® Messages de la conversation:');
    finalConversation.messages.forEach((msg, index) => {
      const sender = msg.sender_id === advertiser.id ? 'Annonceur' : '√âditeur';
      console.log(`   ${index + 1}. [${sender}] ${msg.content}`);
    });
    console.log('');

    console.log('üéâ TEST R√âUSSI ! Conversation cr√©√©e et fonctionnelle entre:');
    console.log(`   üìß Annonceur: ${advertiser.email}`);
    console.log(`   üìß √âditeur: ${publisher.email}`);
    console.log(`   üîó Demande ID: ${createdRequest.id}`);
    console.log(`   üí¨ Conversation ID: ${conversation.id}`);
    console.log('');
    console.log('‚úÖ Cette conversation devrait maintenant √™tre visible dans l\'interface frontend !');

  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale lors du test:', error);
  }
}

// Ex√©cuter le test
testSpecificUsers();
